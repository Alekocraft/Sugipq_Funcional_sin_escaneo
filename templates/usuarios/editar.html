{% extends "base.html" %}

{% block title %}Editar Usuario - Sistema de Inventarios{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<style>
  .form-section-title {
    font-weight: 600;
    margin-bottom: .75rem;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row mb-4">
    <div class="col">
      <h1 class="h2 mb-1">Editar Usuario</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="{{ url_for('usuarios.listar_usuarios') }}">Usuarios</a></li>
          <li class="breadcrumb-item active">Editar</li>
        </ol>
      </nav>
    </div>
    <div class="col-auto">
      <a href="{{ url_for('usuarios.listar_usuarios') }}" class="btn btn-secondary">
        <i class="bi bi-arrow-left"></i> Volver
      </a>
    </div>
  </div>

  <div class="row g-4">
    <!-- Datos del usuario -->
    <div class="col-lg-7">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="d-flex align-items-center gap-2">
            <i class="bi bi-person-badge"></i>
            <span class="fw-semibold">Información</span>
          </div>
          <span class="badge {% if usuario.tipo_auth == 'LDAP' %}bg-info{% else %}bg-secondary{% endif %}">
            {{ usuario.tipo_auth }}
          </span>
        </div>

        <div class="card-body">
          <form method="POST" action="{{ url_for('usuarios.editar_usuario', usuario_id=usuario.id) }}" autocomplete="off">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Usuario</label>
                <input type="text" class="form-control" value="{{ usuario.nombre_usuario }}" readonly>
                <div class="form-text">El nombre de usuario no se puede cambiar.</div>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Correo electrónico</label>
                <input type="email" class="form-control" name="email" value="{{ usuario.email or '' }}" autocomplete="off">
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Rol *</label>
                <select class="form-select" name="rol" required>
                  <option value="">Seleccionar...</option>
                  {% for rol in roles %}
                    <option value="{{ rol }}" {% if rol == usuario.rol %}selected{% endif %}>{{ rol }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Oficina *</label>
                <select class="form-select" name="oficina_id" required>
                  <option value="">Seleccionar...</option>
                  {% for oficina in oficinas %}
                    <option value="{{ oficina.id }}" {% if oficina.id == usuario.oficina_id %}selected{% endif %}>
                      {{ oficina.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6 mb-3">
                <label class="form-label">Aprobador</label>
                <select class="form-select" name="aprobador_id">
                  <option value="">(Sin aprobador)</option>
                  {% for aprobador in aprobadores %}
                    <option value="{{ aprobador.id }}" {% if aprobador.id == usuario.aprobador_id %}selected{% endif %}>
                      {{ aprobador.nombre }}
                    </option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-md-6 mb-3 d-flex align-items-end">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="activo" name="activo" {% if usuario.activo %}checked{% endif %}>
                  <label class="form-check-label" for="activo">Usuario activo</label>
                </div>
              </div>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Guardar cambios
              </button>
              <a href="{{ url_for('usuarios.listar_usuarios') }}" class="btn btn-outline-secondary">Cancelar</a>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Cambiar contraseña (solo LOCAL) -->
    <div class="col-lg-5">
      <div class="card">
        <div class="card-header d-flex align-items-center gap-2">
          <i class="bi bi-shield-lock"></i>
          <span class="fw-semibold">Contraseña</span>
        </div>
        <div class="card-body">
          {% if usuario.tipo_auth == 'LDAP' %}
            <div class="alert alert-info mb-0">
              Este usuario es <strong>LDAP</strong>. La contraseña se administra en el dominio.
            </div>
          {% else %}
            <form method="POST" action="{{ url_for('usuarios.cambiar_contrasena', usuario_id=usuario.id) }}" autocomplete="off">
              <div class="mb-3">
                <label class="form-label">Nueva contraseña *</label>
                <input type="password" class="form-control" name="nueva_contrasena" required autocomplete="off">
              </div>
              <div class="mb-3">
                <label class="form-label">Confirmar contraseña *</label>
                <input type="password" class="form-control" name="confirmar_contrasena" required autocomplete="off">
              </div>
              <button type="submit" class="btn btn-warning">
                <i class="bi bi-key"></i> Cambiar contraseña
              </button>
            </form>
          {% endif %}
        </div>
      </div>

      <div class="card mt-4">
        <div class="card-body">
          <div class="small text-muted">
            <div><strong>ID:</strong> {{ usuario.id }}</div>
            <div><strong>Autenticación:</strong> {{ usuario.tipo_auth }}</div>
            <div><strong>Estado:</strong> {% if usuario.activo %}Activo{% else %}Inactivo{% endif %}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Evita doble envío accidental
  document.addEventListener('submit', function(e) {
    const form = e.target;
    const btn = form.querySelector('button[type="submit"]');
    if (btn) btn.disabled = true;
  }, true);
</script>
{% endblock %}
