<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Usuario - Sistema de Inventarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
</head>
<body>
    {% extends "base.html" %}

    {% block content %}
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <h1 class="h2">Editar Usuario: {{ usuario.nombre_usuario }}</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('auth_bp.dashboard') }}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{{ url_for('usuarios.listar_usuarios') }}">Usuarios</a></li>
                        <li class="breadcrumb-item active">Editar</li>
                    </ol>
                </nav>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('usuarios.listar_usuarios') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Información del Usuario</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('usuarios.editar_usuario', usuario_id=usuario.id) }}" autocomplete="off">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Usuario</label>
                                        <input type="text" class="form-control" value="{{ usuario.nombre_usuario }}" readonly>
                                        <div class="form-text">
                                            Tipo:
                                            <span class="badge {% if usuario.tipo_auth == 'LDAP' %}bg-primary{% else %}bg-success{% endif %}">
                                                {{ usuario.tipo_auth }}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">Correo Electrónico</label>
                                        <input type="email" class="form-control" id="email"
                                               name="email" value="{{ usuario.email or '' }}">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="rol" class="form-label">Rol</label>
                                        <select class="form-select" id="rol" name="rol" required>
                                            <option value="">Seleccionar rol...</option>
                                            {% for rol in roles %}
                                            <option value="{{ rol }}" {% if rol == usuario.rol %}selected{% endif %}>
                                                {{ rol }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="oficina_id" class="form-label">Oficina</label>
                                        <select class="form-select" id="oficina_id" name="oficina_id">
                                            <option value="">Sin asignar</option>
                                            {% for oficina in oficinas %}
                                            <option value="{{ oficina.id }}" {% if oficina.id == usuario.oficina_id %}selected{% endif %}>
                                                {{ oficina.nombre }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="aprobador_id" class="form-label">Aprobador Asignado</label>
                                        <select class="form-select" id="aprobador_id" name="aprobador_id">
                                            <option value="">Sin aprobador</option>
                                            {% for aprobador in aprobadores %}
                                            <option value="{{ aprobador.id }}" {% if aprobador.id == usuario.aprobador_id %}selected{% endif %}>
                                                {{ aprobador.nombre }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" id="activo"
                                               name="activo" {% if usuario.activo %}checked{% endif %}>
                                        <label class="form-check-label" for="activo">Usuario Activo</label>
                                    </div>
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle"></i> Guardar Cambios
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                {% if usuario.tipo_auth == 'LOCAL' %}
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Cambiar Contraseña</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('usuarios.cambiar_contrasena', usuario_id=usuario.id) }}"
                              onsubmit="return validarContrasena()" autocomplete="off">
                            <div class="mb-3">
                                <label for="nueva_contrasena" class="form-label">Nueva Contraseña</label>
                                <input type="password" class="form-control" id="nueva_contrasena" autocomplete="off"
                                       name="nueva_contrasena" required>
                            </div>

                            <div class="mb-3">
                                <label for="confirmar_contrasena" class="form-label">Confirmar Contraseña</label>
                                <input type="password" class="form-control" id="confirmar_contrasena" autocomplete="off"
                                       name="confirmar_contrasena" required>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-warning">
                                    <i class="bi bi-key"></i> Cambiar Contraseña
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}

                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Zona de Peligro</h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Acciones irreversibles</strong>
                        </div>

                        {% if usuario.activo %}
                        <form method="POST" action="{{ url_for('usuarios.desactivar_usuario', usuario_id=usuario.id) }}"
                              onsubmit="return confirm('¿Desactivar usuario {{ usuario.nombre_usuario }}?')" autocomplete="off">
                            <button type="submit" class="btn btn-outline-warning w-100 mb-2">
                                <i class="bi bi-person-dash"></i> Desactivar Usuario
                            </button>
                        </form>
                        {% else %}
                        <form method="POST" action="{{ url_for('usuarios.reactivar_usuario', usuario_id=usuario.id) }}" autocomplete="off">
                            <button type="submit" class="btn btn-outline-success w-100 mb-2">
                                <i class="bi bi-person-check"></i> Reactivar Usuario
                            </button>
                        </form>

                        <form method="POST" action="{{ url_for('usuarios.eliminar_usuario', usuario_id=usuario.id) }}"
                              onsubmit="return confirm('¿ELIMINAR permanentemente a {{ usuario.nombre_usuario }}?\\n\\n?? Esta acción NO se puede deshacer.')" autocomplete="off">
                            <button type="submit" class="btn btn-outline-danger w-100">
                                <i class="bi bi-trash"></i> Eliminar Permanentemente
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <script>
        function validarContrasena() {
            const nueva = document.getElementById('nueva_contrasena').value;
            const confirmar = document.getElementById('confirmar_contrasena').value;

            if (nueva !== confirmar) {
                alert('Las contraseñas no coinciden');
                return false;
            }

            if (nueva.length < 6) {
                alert('La contraseña debe tener al menos 6 caracteres');
                return false;
            }

            return confirm('¿Está seguro de cambiar la contraseña?');
        }
    </script>
    {% endblock %}
</body>
</html>