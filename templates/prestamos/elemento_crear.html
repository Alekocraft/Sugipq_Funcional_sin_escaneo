{% extends "base.html" %}
{% block title %}Crear Material - Préstamos{% endblock %}

{% block content %}
<div class="container fade-in">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="fw-bold" style="color: #A73493;">
            <i class="fas fa-plus-circle"></i> Crear Material para Préstamos
        </h1>
        <a href="/prestamos" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Préstamos
        </a>
    </div>

    <div id="alertas"></div>

    <div class="card border-0 shadow-sm">
        <div class="card-body">

            <form id="materialForm" enctype="multipart/form-data">

                <div class="row g-3">

                    <!-- Nombre -->
                    <div class="col-md-6">
                        <label class="form-label">Nombre del Elemento*</label>
                        <input type="text" name="nombre_elemento" class="form-control" required>
                    </div>

                    <!-- Valor Unitario -->
                    <div class="col-md-3">
                        <label class="form-label">Valor unitario*</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" min="0.01" 
                                   name="valor_unitario" class="form-control" required>
                        </div>
                    </div>

                    <!-- Cantidad Disponible -->
                    <div class="col-md-3">
                        <label class="form-label">Cantidad disponible*</label>
                        <input type="number" min="0" name="cantidad_disponible" class="form-control" required>
                    </div>

                    <!-- Cantidad mínima -->
                    <div class="col-md-3">
                        <label class="form-label">Cantidad mínima*</label>
                        <input type="number" min="0" name="cantidad_minima" class="form-control" required>
                    </div>

                    <!-- Oficina (FIJA - COQ) -->
                    <div class="col-md-3">
                        <label class="form-label">Oficina creadora</label>
                        <input type="text" class="form-control" value="COQ" readonly disabled>
                        <input type="hidden" name="oficina_creadora_id" value="1">
                    </div>

                    <!-- Activo (SIEMPRE ACTIVO) -->
                    <div class="col-md-3 d-flex align-items-center">
                        <div class="form-check mt-4">
                            <input class="form-check-input" type="checkbox" checked disabled>
                            <label class="form-check-label">Activo (Siempre habilitado)</label>
                        </div>
                    </div>

                    <!-- Imagen -->
                    <div class="col-12">
                        <label class="form-label">Imagen*</label>
                        <input type="file" name="imagen" accept="image/*" class="form-control" required>
                    </div>

                </div>

                <div class="mt-3 d-flex gap-2">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-save"></i> Crear Material
                    </button>
                    <a href="/prestamos" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>

            </form>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById("materialForm");
    const submitBtn = document.getElementById("submitBtn");
    let enviando = false;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (enviando) {
            return;
        }
        enviando = true;

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';

        try {
            const data = new FormData(form);

            const resp = await fetch("/prestamos/elementos/crearmaterial", {
                method: "POST",
                body: data,
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            });

            const json = await resp.json();
            
            mostrarAlerta(json.message, json.success ? "success" : "danger");

            if (json.success) {
                form.reset();
                
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Crear Material';
                    enviando = false;
                }, 3000);
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Crear Material';
                enviando = false;
            }

        } catch (error) {
            console.error("Error en creación de material");
            mostrarAlerta("Error inesperado del servidor", "danger");
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> Crear Material';
            enviando = false;
        }
    });

    function mostrarAlerta(msg, tipo) {
        document.getElementById("alertas").innerHTML = `
            <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        if (tipo === 'success') {
            setTimeout(() => {
                const alert = document.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    }

    submitBtn.addEventListener('click', function(e) {
        if (enviando) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    });
});
</script>
{% endblock %}