{% extends "base.html" %}
{% block title %}Pr√©stamos - Sistema de Gesti√≥n{% endblock %}

{% block content %}
<div class="container-fluid py-4">

  {# =========================
     Permisos (solo template)
     - Evitamos can_view_actions() porque en tu proyecto no siempre existe / cambia firma
     - Usamos can_access(), que el m√≥dulo de pr√©stamos ya utiliza en backend
     ========================= #}
  {% set can_create = (can_access('prestamos', 'create') if can_access is defined else false) %}
  {% set can_approve = (can_access('prestamos', 'approve') if can_access is defined else false) %}
  {% set can_reject = (can_access('prestamos', 'reject') if can_access is defined else false) %}
  {% set can_return = (can_access('prestamos', 'return') if can_access is defined else false) %}
  {% set show_actions = can_approve or can_reject or can_return %}
  {% set can_export = ((can_access('prestamos', 'view') or can_access('prestamos', 'view_all') or can_access('prestamos', 'view_own')) if can_access is defined else false) %}

  {# Querystring para exportar con los mismos filtros #}
  {% set _qs = request.query_string %}
  {% if _qs %}
    {% set qs = _qs.decode('utf-8') if _qs is not string else _qs %}
  {% else %}
    {% set qs = '' %}
  {% endif %}

  <div class="d-flex justify-content-between align-items-start mb-3">
    <div>
      <h1 class="fw-bold mb-1"><i class="fas fa-exchange-alt me-2"></i>Pr√©stamos de Material</h1>
      <div class="text-muted">Control y seguimiento de pr√©stamos</div>
    </div>

    <div class="d-flex gap-2">
      {% if can_create %}
      <a class="btn btn-primary" href="/prestamos/crear">
        <i class="fas fa-plus me-2"></i>Nuevo Pr√©stamo
      </a>
      {% endif %}

      {% if can_export %}
      <a class="btn btn-success" href="/prestamos/exportar/excel{% if qs %}?{{ qs }}{% endif %}">
        <i class="fas fa-file-excel me-2"></i>Exportar Excel
      </a>
      <a class="btn btn-danger" href="/prestamos/exportar/pdf{% if qs %}?{{ qs }}{% endif %}">
        <i class="fas fa-file-pdf me-2"></i>Exportar PDF
      </a>
      {% endif %}
    </div>
  </div>

  <div class="alert alert-info mb-4">
    <strong>üìä Vista de pr√©stamos:</strong>
    {% if session.rol in ['administrador', 'lider_inventario'] %}
      Mostrando pr√©stamos de <strong>TODAS</strong> las oficinas.
    {% else %}
      Mostrando pr√©stamos √∫nicamente de su oficina: <strong>{{ session.oficina_nombre }}</strong>
    {% endif %}
  </div>

  {# =========================
     Resumen
     ========================= #}
  <div class="row g-3 mb-4">
    <div class="col-md-2">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-muted">Total</div>
          <div class="fs-3 fw-bold">{{ prestamos|length }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-muted">Pendientes</div>
          <div class="fs-3 fw-bold text-warning">
            {{ prestamos|selectattr('estado', 'equalto', 'PENDIENTE')|list|length }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-muted">Aprobados</div>
          <div class="fs-3 fw-bold text-success">
            {{ (prestamos|selectattr('estado', 'equalto', 'APROBADO')|list|length) +
               (prestamos|selectattr('estado', 'equalto', 'APROBADO_PARCIAL')|list|length) }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-muted">Rechazados</div>
          <div class="fs-3 fw-bold text-danger">
            {{ prestamos|selectattr('estado', 'equalto', 'RECHAZADO')|list|length }}
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card h-100">
        <div class="card-body text-center">
          <div class="text-muted">Devueltos</div>
          <div class="fs-3 fw-bold text-secondary">
            {{ prestamos|selectattr('estado', 'equalto', 'DEVUELTO')|list|length }}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# =========================
     Filtros
     ========================= #}
  <div class="card mb-4">
    <div class="card-header bg-info text-white">
      <i class="fas fa-filter me-2"></i>Filtros de b√∫squeda
    </div>
    <div class="card-body">
      <form method="GET" action="/prestamos/">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Estado</label>
            <select name="estado" class="form-select">
              <option value="">Todos</option>
              {% for e in estados %}
                <option value="{{ e }}" {% if filtro_estado == e %}selected{% endif %}>{{ e }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">Oficina</label>
            {% if session.rol in ['administrador', 'lider_inventario'] %}
              <select name="oficina" class="form-select">
                <option value="todas" {% if filtro_oficina == 'todas' %}selected{% endif %}>Todas</option>
                {% for o in oficinas %}
                  <option value="{{ o.id }}" {% if filtro_oficina == o.id|string %}selected{% endif %}>{{ o.nombre }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input type="text" class="form-control" value="{{ session.oficina_nombre }}" disabled>
              <input type="hidden" name="oficina" value="{{ filtro_oficina }}">
            {% endif %}
          </div>

          <div class="col-md-3">
            <label class="form-label">Material</label>
            <input type="text" class="form-control" name="material" value="{{ filtro_material }}" placeholder="Buscar por material...">
          </div>

          <div class="col-md-3">
            <label class="form-label">Solicitante</label>
            <input type="text" class="form-control" name="solicitante" value="{{ filtro_solicitante }}" placeholder="Buscar por solicitante...">
          </div>

          <div class="col-md-3">
            <label class="form-label">Fecha inicio</label>
            <input type="date" class="form-control" name="fecha_inicio" value="{{ filtro_fecha_inicio }}">
          </div>

          <div class="col-md-3">
            <label class="form-label">Fecha fin</label>
            <input type="date" class="form-control" name="fecha_fin" value="{{ filtro_fecha_fin }}">
          </div>

          <div class="col-md-6 d-flex align-items-end justify-content-end gap-2">
            <button class="btn btn-primary" type="submit">
              <i class="fas fa-search me-2"></i>Aplicar
            </button>
            <a class="btn btn-secondary" href="/prestamos/">
              <i class="fas fa-undo me-2"></i>Limpiar
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  {# =========================
     Tabla (filas sin acciones abajo)
     ========================= #}
  <div class="card">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
      <div><i class="fas fa-list me-2"></i>Lista de Pr√©stamos</div>
      <span class="badge bg-light text-dark rounded-pill">{{ prestamos|length }} registros</span>
    </div>

    <div class="card-body">
      <div class="table-responsive" style="max-height: 650px; overflow: auto;">
        <table class="table table-striped table-hover table-sm align-middle mb-0">
          <thead class="table-dark sticky-top">
            <tr>
              <th>#</th>
              <th>Material</th>
              <th class="text-end">Cant.</th>
              <th class="text-end">V. Unitario</th>
              <th class="text-end">Subtotal</th>
              <th>Solicitante</th>
              <th>Oficina</th>
              <th>Fecha</th>
              <th>Prevista</th>
              <th>Estado</th>
              {% if show_actions %}<th class="text-center">Acciones</th>{% endif %}
            </tr>
          </thead>

          <tbody>
            {% set ns = namespace(actionable=[], nonactionable=[]) %}
            {% for r in prestamos %}
              {% set fila_actionable = false %}
              {% if r.estado == 'PENDIENTE' and (can_approve or can_reject) %}
                {% set fila_actionable = true %}
              {% elif r.estado in ['APROBADO', 'APROBADO_PARCIAL'] and can_return %}
                {% set fila_actionable = true %}
              {% endif %}

              {% if fila_actionable %}
                {% set ns.actionable = ns.actionable + [r] %}
              {% else %}
                {% set ns.nonactionable = ns.nonactionable + [r] %}
              {% endif %}
            {% endfor %}

            {% set prestamos_ordenados = ns.actionable + ns.nonactionable %}

            {% for r in prestamos_ordenados %}
            <tr id="prestamo-{{ r.id }}" data-estado="{{ r.estado }}">
              <td class="fw-semibold">{{ r.id }}</td>
              <td><i class="fas fa-box me-2 text-muted"></i>{{ r.material }}</td>
              <td class="text-end fw-semibold">{{ r.cantidad }}</td>
              <td class="text-end">${{ "%.2f"|format(r.valor_unitario) }}</td>
              <td class="text-end fw-bold text-primary">${{ "%.2f"|format(r.subtotal) }}</td>
              <td><i class="fas fa-user me-2 text-muted"></i>{{ r.solicitante_nombre }}</td>
              <td><i class="fas fa-building me-2 text-muted"></i>{{ r.oficina_nombre }}</td>
              <td><small class="text-muted">{{ format_date(r.fecha, '%Y-%m-%d %H:%M') }}</small></td>
              <td><small class="text-muted">{{ format_date(r.fecha_prevista, '%Y-%m-%d') }}</small></td>
              <td>
                {% if r.estado == 'PENDIENTE' %}
                  <span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>PENDIENTE</span>
                {% elif r.estado == 'APROBADO' %}
                  <span class="badge bg-success"><i class="fas fa-check me-1"></i>APROBADO</span>
                {% elif r.estado == 'APROBADO_PARCIAL' %}
                  <span class="badge bg-info"><i class="fas fa-check-double me-1"></i>APROBADO PARCIAL</span>
                {% elif r.estado == 'RECHAZADO' %}
                  <span class="badge bg-danger"><i class="fas fa-times me-1"></i>RECHAZADO</span>
                {% elif r.estado == 'DEVUELTO' %}
                  <span class="badge bg-secondary"><i class="fas fa-undo me-1"></i>DEVUELTO</span>
                {% else %}
                  <span class="badge bg-dark">{{ r.estado }}</span>
                {% endif %}
              </td>

              {% if show_actions %}
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  {% if r.estado == 'PENDIENTE' %}
                    {% if can_approve %}
                      <button class="btn btn-outline-success" type="button" title="Aprobar"
                              onclick="aprobarPrestamo({{ r.id }})">
                        <i class="fas fa-check"></i>
                      </button>
                      <button class="btn btn-outline-warning" type="button" title="Aprobar parcial"
                              onclick="openAprobarParcial({{ r.id }}, {{ r.cantidad }})">
                        <i class="fas fa-check-double"></i>
                      </button>
                    {% endif %}
                    {% if can_reject %}
                      <button class="btn btn-outline-danger" type="button" title="Rechazar"
                              onclick="openRechazar({{ r.id }})">
                        <i class="fas fa-times"></i>
                      </button>
                    {% endif %}
                    {% if not (can_approve or can_reject) %}
                      <span class="text-muted small">N/A</span>
                    {% endif %}

                  {% elif r.estado in ['APROBADO', 'APROBADO_PARCIAL'] %}
                    {% if can_return %}
                      <button class="btn btn-outline-info" type="button" title="Registrar devoluci√≥n"
                              onclick="openDevolucion({{ r.id }})">
                        <i class="fas fa-undo"></i>
                      </button>
                    {% else %}
                      <span class="text-muted small">N/A</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted small">N/A</span>
                  {% endif %}
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}

            {% if not prestamos %}
            <tr>
              <td colspan="{% if show_actions %}11{% else %}10{% endif %}" class="text-center py-5">
                <div class="d-flex flex-column align-items-center">
                  <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">No se encontraron pr√©stamos</h5>
                  <p class="text-muted mb-0">No hay registros con los filtros seleccionados.</p>
                </div>
              </td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

{# =========================
   Modales
   ========================= #}

<div class="modal fade" id="modalAprobarParcial" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="fas fa-check-double me-2"></i>Aprobar parcial</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formAprobarParcial">
          <input type="hidden" id="ap_id">
          <div class="mb-3">
            <label class="form-label">Cantidad a aprobar</label>
            <input type="number" class="form-control" id="ap_cantidad" min="1" required>
            <div class="form-text">M√°ximo: <span id="ap_max"></span></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Observaci√≥n (opcional)</label>
            <textarea class="form-control" id="ap_obs" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-warning">
            <i class="fas fa-check-double me-2"></i>Confirmar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalRechazar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="fas fa-times me-2"></i>Rechazar pr√©stamo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formRechazar">
          <input type="hidden" id="rj_id">
          <div class="mb-3">
            <label class="form-label">Motivo / Observaci√≥n</label>
            <textarea class="form-control" id="rj_obs" rows="3" required></textarea>
          </div>
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-times me-2"></i>Rechazar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalDevolucion" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="fas fa-undo me-2"></i>Registrar devoluci√≥n</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <form id="formDevolucion">
          <input type="hidden" id="dv_id">
          <div class="mb-3">
            <label class="form-label">Observaci√≥n (opcional)</label>
            <textarea class="form-control" id="dv_obs" rows="3"></textarea>
          </div>
          <button type="submit" class="btn btn-info">
            <i class="fas fa-undo me-2"></i>Registrar
          </button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function postJSON(url, payload) {
    return fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload || {})
    }).then(r => r.json().then(j => ({ ok: r.ok, status: r.status, json: j })));
  }

  function aprobarPrestamo(id) {
    if (!confirm("¬øAprobar este pr√©stamo?")) return;
    postJSON(`/prestamos/${id}/aprobar`, {})
      .then(({ok, json}) => {
        if (ok && json.success) {
          alert("‚úÖ Pr√©stamo aprobado.");
          window.location.reload();
        } else {
          alert("‚ùå " + (json.message || "No fue posible aprobar."));
        }
      })
      .catch(() => alert("‚ùå Error de conexi√≥n."));
  }

  function openAprobarParcial(id, maxCant) {
    document.getElementById("ap_id").value = id;
    document.getElementById("ap_max").textContent = maxCant;
    const input = document.getElementById("ap_cantidad");
    input.max = maxCant;
    input.value = "";
    document.getElementById("ap_obs").value = "";
    new bootstrap.Modal(document.getElementById("modalAprobarParcial")).show();
  }

  function openRechazar(id) {
    document.getElementById("rj_id").value = id;
    document.getElementById("rj_obs").value = "";
    new bootstrap.Modal(document.getElementById("modalRechazar")).show();
  }

  function openDevolucion(id) {
    document.getElementById("dv_id").value = id;
    document.getElementById("dv_obs").value = "";
    new bootstrap.Modal(document.getElementById("modalDevolucion")).show();
  }

  document.getElementById("formAprobarParcial").addEventListener("submit", function(e) {
    e.preventDefault();
    const id = document.getElementById("ap_id").value;
    const cantidad = parseInt(document.getElementById("ap_cantidad").value || "0", 10);
    const obs = (document.getElementById("ap_obs").value || "").trim();

    if (!cantidad || cantidad <= 0) {
      alert("Ingrese una cantidad v√°lida.");
      return;
    }

    postJSON(`/prestamos/${id}/aprobar_parcial`, { cantidad_aprobada: cantidad, observaciones: obs })
      .then(({ok, json}) => {
        if (ok && json.success) {
          alert("‚úÖ Aprobaci√≥n parcial registrada.");
          window.location.reload();
        } else {
          alert("‚ùå " + (json.message || "No fue posible aprobar parcialmente."));
        }
      })
      .catch(() => alert("‚ùå Error de conexi√≥n."));
  });

  document.getElementById("formRechazar").addEventListener("submit", function(e) {
    e.preventDefault();
    const id = document.getElementById("rj_id").value;
    const obs = (document.getElementById("rj_obs").value || "").trim();
    if (!obs) {
      alert("La observaci√≥n es obligatoria.");
      return;
    }

    postJSON(`/prestamos/${id}/rechazar`, { observacion: obs })
      .then(({ok, json}) => {
        if (ok && json.success) {
          alert("‚úÖ Pr√©stamo rechazado.");
          window.location.reload();
        } else {
          alert("‚ùå " + (json.message || "No fue posible rechazar."));
        }
      })
      .catch(() => alert("‚ùå Error de conexi√≥n."));
  });

  document.getElementById("formDevolucion").addEventListener("submit", function(e) {
    e.preventDefault();
    const id = document.getElementById("dv_id").value;
    const obs = (document.getElementById("dv_obs").value || "").trim();

    postJSON(`/prestamos/${id}/devolucion`, { observacion: obs })
      .then(({ok, json}) => {
        if (ok && json.success) {
          alert("‚úÖ Devoluci√≥n registrada.");
          window.location.reload();
        } else {
          alert("‚ùå " + (json.message || "No fue posible registrar la devoluci√≥n."));
        }
      })
      .catch(() => alert("‚ùå Error de conexi√≥n."));
  });
</script>
{% endblock %}
