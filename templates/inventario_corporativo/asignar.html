{% extends "base.html" %}
{% block title %}Asignar a Oficina{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Botón de volver -->
    <div class="row mb-3">
        <div class="col-md-12">
            <a href="/inventario-corporativo/{{ producto.id }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al Producto
            </a>
        </div>
    </div>

    <h1>Asignar Producto a Oficina</h1>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Información del Producto -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Información del Producto</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Producto:</strong> {{ producto.nombre }}</p>
                            <p><strong>Código:</strong> 
                                <span class="badge bg-dark">{{ producto.codigo_unico }}</span>
                            </p>
                            <p><strong>Categoría:</strong> 
                                <span class="badge bg-secondary">{{ producto.categoria or 'Sin categoría' }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Stock Disponible:</strong> 
                                <span class="badge bg-success fs-6">{{ producto.cantidad }} unidades</span>
                            </p>
                            <p><strong>Estado:</strong> 
                                <span class="badge bg-success">
                                    <i class="fas fa-check-circle me-1"></i>Disponible
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario de Asignación -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-share-square me-2"></i>Asignar Producto</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="formAsignacion">
                        <div class="row">
                            <!-- Oficina Destino -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-building me-2"></i>Oficina Destino <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" name="oficina_id" required>
                                        <option value="" disabled selected>Seleccione una oficina...</option>
                                        {% for o in oficinas %}
                                        <option value="{{ o.id }}">{{ o.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">Seleccione la oficina a la que asignará el producto</div>
                                </div>
                            </div>
                            
                            <!-- Cantidad -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-boxes me-2"></i>Cantidad a Asignar <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" 
                                           class="form-control" 
                                           name="cantidad" 
                                           min="1" 
                                           max="{{ producto.cantidad }}" 
                                           placeholder="Máximo: {{ producto.cantidad }}" 
                                           required>
                                    <div class="form-text">
                                        Stock máximo disponible: <strong>{{ producto.cantidad }} unidades</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Sección de Usuario AD -->
                        <div class="card border mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-user-tie me-2"></i>Asignar a Usuario del Directorio Activo
                                    <span class="badge bg-info ms-2">Opcional</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Buscador de usuarios AD -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-search me-2"></i>Buscar Usuario
                                    </label>
                                    <div class="input-group">
                                        <input type="text" 
                                               class="form-control" 
                                               id="busquedaUsuarioAD" 
                                               placeholder="Ingrese nombre o usuario (mínimo 3 caracteres)..."
                                               autocomplete="off">
                                        <button class="btn btn-outline-primary" type="button" id="btnBuscarAD">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">
                                        {% if ldap_disponible %}
                                        <span class="text-success"><i class="fas fa-check-circle me-1"></i>Conexión a Active Directory disponible</span>
                                        {% else %}
                                        <span class="text-warning"><i class="fas fa-exclamation-triangle me-1"></i>Active Directory no disponible - ingrese datos manualmente</span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Resultados de búsqueda -->
                                <div id="resultadosAD" class="mb-3" style="display: none;">
                                    <label class="form-label">Resultados de búsqueda:</label>
                                    <div id="listaResultadosAD" class="list-group" style="max-height: 200px; overflow-y: auto;">
                                        <!-- Resultados dinámicos -->
                                    </div>
                                </div>
                                
                                <!-- Usuario seleccionado -->
                                <div id="usuarioSeleccionado" class="alert alert-info" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1"><i class="fas fa-user-check me-2"></i>Usuario Seleccionado:</h6>
                                            <p class="mb-0" id="infoUsuarioSeleccionado"></p>
                                        </div>
                                        <button type="button" class="btn btn-sm btn-outline-danger" id="btnLimpiarUsuario">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Campos ocultos para datos del usuario -->
                                <input type="hidden" name="usuario_ad_username" id="usuario_ad_username">
                                <input type="hidden" name="usuario_ad_nombre" id="usuario_ad_nombre">
                                <input type="hidden" name="usuario_ad_email" id="usuario_ad_email">
                                
                                <!-- Campos manuales (si no hay AD) -->
                                <div id="camposManuales" style="display: none;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Usuario</label>
                                                <input type="text" class="form-control" id="usuarioManual" placeholder="usuario123">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Nombre Completo</label>
                                                <input type="text" class="form-control" id="nombreManual" placeholder="Juan Pérez">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label class="form-label">Email</label>
                                                <input type="email" class="form-control" id="emailManual" placeholder="usuario@qualitascolombia.com.co">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="btnUsarDatosManuales">
                                        <i class="fas fa-check me-1"></i>Usar estos datos
                                    </button>
                                </div>
                                
                                <!-- Toggle para ingreso manual -->
                                <div class="mt-2">
                                    <a href="#" id="toggleModoManual" class="text-decoration-none small">
                                        <i class="fas fa-keyboard me-1"></i>Ingresar datos manualmente
                                    </a>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Opciones de notificación -->
                        <div class="card border mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-bell me-2"></i>Notificación
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enviar_notificacion" name="enviar_notificacion" checked>
                                    <label class="form-check-label" for="enviar_notificacion">
                                        <i class="fas fa-envelope me-2"></i>Enviar notificación por correo al usuario asignado
                                    </label>
                                </div>
                                <div class="form-text">
                                    Se enviará un email automático informando sobre la asignación del producto.
                                </div>
                                
                                <!-- Preview del email -->
                                <div id="previewNotificacion" class="mt-3 p-3 bg-light rounded border" style="display: none;">
                                    <small class="text-muted d-block mb-2">Vista previa del destinatario:</small>
                                    <div id="destinatarioPreview">
                                        <span class="badge bg-secondary">Ningún usuario seleccionado</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de acción -->
                        <div class="d-flex justify-content-between align-items-center mt-4">
                            <a href="/inventario-corporativo/{{ producto.id }}" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-success btn-lg" id="btnConfirmar">
                                <i class="fas fa-check me-2"></i>Confirmar Asignación
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Historial de Movimientos -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Historial Reciente de Movimientos</h5>
                </div>
                <div class="card-body p-0">
                    {% if historial %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Acción</th>
                                    <th>Oficina</th>
                                    <th>Usuario Asignado</th>
                                    <th>Cantidad</th>
                                    <th>Realizado por</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for h in historial[:10] %}
                                <tr>
                                    <td>
                                        {% if h.Fecha %}
                                        {{ h.Fecha.strftime('%d/%m/%Y %H:%M') }}
                                        {% else %}
                                        <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if h.Accion == 'ASIGNAR' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-share-square me-1"></i>Asignación
                                        </span>
                                        {% elif h.Accion == 'BAJA_PRODUCTO' %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-trash me-1"></i>Baja
                                        </span>
                                        {% elif h.Accion == 'AJUSTE' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-adjust me-1"></i>Ajuste
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-exchange-alt me-1"></i>{{ h.Accion }}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if h.oficina %}
                                        <span class="badge bg-outline-primary">
                                            <i class="fas fa-building me-1"></i>{{ h.oficina }}
                                        </span>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if h.usuario_asignado or h.UsuarioAsignadoNombre %}
                                        <span class="text-primary">
                                            <i class="fas fa-user me-1"></i>{{ h.usuario_asignado or h.UsuarioAsignadoNombre }}
                                        </span>
                                        {% if h.email_asignado or h.UsuarioAsignadoEmail %}
                                        <br><small class="text-muted">{{ h.email_asignado or h.UsuarioAsignadoEmail }}</small>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">{{ h.Cantidad }}</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ h.UsuarioAccion or 'Sistema' }}</small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No hay movimientos registrados</h5>
                        <p class="text-muted">Este producto no tiene historial de movimientos.</p>
                    </div>
                    {% endif %}
                </div>
                {% if historial|length > 10 %}
                <div class="card-footer bg-light">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Mostrando los 10 movimientos más recientes
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
    .fade-in {
        animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .table th {
        white-space: nowrap;
    }
    
    .badge {
        font-size: 0.8em;
    }
    
    .bg-outline-primary {
        background-color: transparent;
        border: 1px solid #0d6efd;
        color: #0d6efd;
    }
    
    .form-select:focus, .form-control:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }
    
    .btn-success {
        transition: all 0.3s ease;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
    }
    
    /* Estilos para resultados de búsqueda AD */
    .list-group-item-action:hover {
        background-color: #e3f2fd;
        cursor: pointer;
    }
    
    .usuario-resultado {
        border-left: 3px solid #0d6efd;
    }
    
    .usuario-resultado:hover {
        border-left-color: #198754;
    }
    
    /* Animación de carga */
    .spinner-grow-sm {
        width: 1rem;
        height: 1rem;
    }
    
    /* Transición suave */
    #usuarioSeleccionado, #resultadosAD, #camposManuales, #previewNotificacion {
        transition: all 0.3s ease;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del DOM
    const inputBusqueda = document.getElementById('busquedaUsuarioAD');
    const btnBuscar = document.getElementById('btnBuscarAD');
    const resultadosDiv = document.getElementById('resultadosAD');
    const listaResultados = document.getElementById('listaResultadosAD');
    const usuarioSeleccionadoDiv = document.getElementById('usuarioSeleccionado');
    const infoUsuario = document.getElementById('infoUsuarioSeleccionado');
    const btnLimpiar = document.getElementById('btnLimpiarUsuario');
    const toggleManual = document.getElementById('toggleModoManual');
    const camposManuales = document.getElementById('camposManuales');
    const btnUsarDatosManuales = document.getElementById('btnUsarDatosManuales');
    const checkNotificacion = document.getElementById('enviar_notificacion');
    const previewNotificacion = document.getElementById('previewNotificacion');
    const destinatarioPreview = document.getElementById('destinatarioPreview');
    
    // Campos ocultos
    const hiddenUsername = document.getElementById('usuario_ad_username');
    const hiddenNombre = document.getElementById('usuario_ad_nombre');
    const hiddenEmail = document.getElementById('usuario_ad_email');
    
    // Variable para timeout de búsqueda
    let searchTimeout = null;
    
    // Función para buscar usuarios
    function buscarUsuarios() {
        const termino = inputBusqueda.value.trim();
        
        if (termino.length < 3) {
            resultadosDiv.style.display = 'none';
            return;
        }
        
        // Mostrar indicador de carga
        listaResultados.innerHTML = `
            <div class="list-group-item text-center">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                    <span class="visually-hidden">Buscando...</span>
                </div>
                <span class="ms-2">Buscando en Active Directory...</span>
            </div>
        `;
        resultadosDiv.style.display = 'block';
        
        // Llamar a la API
        fetch(`/inventario-corporativo/api/buscar-usuarios-ad?q=${encodeURIComponent(termino)}`)
            .then(response => response.json())
            .then(data => {
                listaResultados.innerHTML = '';
                
                if (data.error && data.usuarios.length === 0) {
                    listaResultados.innerHTML = `
                        <div class="list-group-item text-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>${data.error}
                        </div>
                    `;
                } else if (data.usuarios && data.usuarios.length > 0) {
                    data.usuarios.forEach(usuario => {
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action usuario-resultado';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong><i class="fas fa-user me-2"></i>${usuario.nombre}</strong>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-at me-1"></i>${usuario.usuario}
                                        ${usuario.email ? ` | <i class="fas fa-envelope me-1"></i>${usuario.email}` : ''}
                                    </small>
                                    ${usuario.departamento ? `<br><small class="text-secondary"><i class="fas fa-building me-1"></i>${usuario.departamento}</small>` : ''}
                                </div>
                                <i class="fas fa-chevron-right text-muted"></i>
                            </div>
                        `;
                        item.onclick = function() {
                            seleccionarUsuario(usuario);
                        };
                        listaResultados.appendChild(item);
                    });
                } else {
                    listaResultados.innerHTML = `
                        <div class="list-group-item text-muted">
                            <i class="fas fa-search me-2"></i>No se encontraron usuarios con "${termino}"
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                listaResultados.innerHTML = `
                    <div class="list-group-item text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>Error al buscar usuarios
                    </div>
                `;
            });
    }
    
    // Función para seleccionar usuario
    function seleccionarUsuario(usuario) {
        // Llenar campos ocultos
        hiddenUsername.value = usuario.usuario || '';
        hiddenNombre.value = usuario.nombre || '';
        hiddenEmail.value = usuario.email || '';
        
        // Mostrar usuario seleccionado
        infoUsuario.innerHTML = `
            <strong>${usuario.nombre}</strong><br>
            <small>
                <i class="fas fa-at me-1"></i>${usuario.usuario}
                ${usuario.email ? ` | <i class="fas fa-envelope me-1"></i>${usuario.email}` : ''}
                ${usuario.departamento ? ` | <i class="fas fa-building me-1"></i>${usuario.departamento}` : ''}
            </small>
        `;
        usuarioSeleccionadoDiv.style.display = 'block';
        
        // Ocultar resultados
        resultadosDiv.style.display = 'none';
        inputBusqueda.value = '';
        
        // Actualizar preview de notificación
        actualizarPreviewNotificacion(usuario);
        
        // Ocultar modo manual si estaba visible
        camposManuales.style.display = 'none';
    }
    
    // Función para limpiar usuario seleccionado
    function limpiarUsuario() {
        hiddenUsername.value = '';
        hiddenNombre.value = '';
        hiddenEmail.value = '';
        usuarioSeleccionadoDiv.style.display = 'none';
        destinatarioPreview.innerHTML = '<span class="badge bg-secondary">Ningún usuario seleccionado</span>';
    }
    
    // Función para actualizar preview de notificación
    function actualizarPreviewNotificacion(usuario) {
        if (checkNotificacion.checked && usuario && usuario.email) {
            previewNotificacion.style.display = 'block';
            destinatarioPreview.innerHTML = `
                <i class="fas fa-user text-primary me-2"></i>${usuario.nombre}
                <br>
                <i class="fas fa-envelope text-success me-2"></i>${usuario.email}
            `;
        } else if (checkNotificacion.checked) {
            previewNotificacion.style.display = 'block';
            destinatarioPreview.innerHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle me-1"></i>Usuario sin email - no se enviará notificación</span>';
        } else {
            previewNotificacion.style.display = 'none';
        }
    }
    
    // Event Listeners
    
    // Búsqueda con debounce
    inputBusqueda.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(buscarUsuarios, 500);
    });
    
    // Botón buscar
    btnBuscar.addEventListener('click', buscarUsuarios);
    
    // Enter en campo de búsqueda
    inputBusqueda.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarUsuarios();
        }
    });
    
    // Limpiar usuario
    btnLimpiar.addEventListener('click', limpiarUsuario);
    
    // Toggle modo manual
    toggleManual.addEventListener('click', function(e) {
        e.preventDefault();
        if (camposManuales.style.display === 'none') {
            camposManuales.style.display = 'block';
            this.innerHTML = '<i class="fas fa-search me-1"></i>Volver a búsqueda AD';
        } else {
            camposManuales.style.display = 'none';
            this.innerHTML = '<i class="fas fa-keyboard me-1"></i>Ingresar datos manualmente';
        }
    });
    
    // Usar datos manuales
    btnUsarDatosManuales.addEventListener('click', function() {
        const usuario = {
            usuario: document.getElementById('usuarioManual').value.trim(),
            nombre: document.getElementById('nombreManual').value.trim(),
            email: document.getElementById('emailManual').value.trim()
        };
        
        if (!usuario.usuario && !usuario.nombre) {
            alert('Por favor ingrese al menos el usuario o nombre');
            return;
        }
        
        seleccionarUsuario(usuario);
        camposManuales.style.display = 'none';
    });
    
    // Cambio en checkbox de notificación
    checkNotificacion.addEventListener('change', function() {
        const usuario = {
            nombre: hiddenNombre.value,
            email: hiddenEmail.value
        };
        actualizarPreviewNotificacion(usuario.email ? usuario : null);
    });
    
    // Validación antes de enviar
    document.getElementById('formAsignacion').addEventListener('submit', function(e) {
        const cantidad = document.querySelector('input[name="cantidad"]').value;
        const oficina = document.querySelector('select[name="oficina_id"]').value;
        
        if (!oficina) {
            e.preventDefault();
            alert('Por favor seleccione una oficina de destino');
            return;
        }
        
        if (!cantidad || cantidad < 1) {
            e.preventDefault();
            alert('Por favor ingrese una cantidad válida');
            return;
        }
        
        // Confirmar si hay usuario seleccionado
        if (hiddenUsername.value || hiddenNombre.value) {
            const mensaje = `¿Confirmar asignación a ${hiddenNombre.value || hiddenUsername.value}?`;
            if (!confirm(mensaje)) {
                e.preventDefault();
            }
        }
    });
});
</script>
{% endblock %}